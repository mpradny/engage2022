trigger: none

resources:
  - repo: self

variables:
  imageTag: V1201_390s
  imageRepository: 'pristo/enagage2022'
  dockerfilePath: '$(Build.SourcesDirectory)/docker/Dockerfile'
  dockerRegistryServiceConnection: 'GitLab.com'
  tag: '$(Build.BuildId)'

pool:
  vmImage: ubuntu-latest

stages:
- stage: build 
  displayName: Build NTF
  jobs:
  - job: build
    steps:
    - checkout: self
      clean: true
    - script: chmod -R go+rwx .
      displayName: 'Adjust permissions'
    - task: Docker@2
      inputs:
        containerRegistry: 'DockerHub'
        command: 'login'
    - script: docker run --rm -v $(pwd):/local/project -w /local/project mpradny/domino-appbuild:$(imageTag) mvn -o package
      displayName: 'Run docker build'
    - task: Docker@2
      inputs:
        containerRegistry: 'DockerHub'
        command: 'logout'
    - task: CopyFiles@2
      inputs:
        SourceFolder: 'target/'
        Contents: '*.ntf'
        TargetFolder: '$(Build.ArtifactStagingDirectory)'
    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'templates'
        publishLocation: 'Container'

    - script: docker run --rm -v $(pwd):/local/project -w /local/project mpradny/domino-appbuild:$(imageTag) rm -rf ./*
      displayName: 'Work dir cleanup with permissions from the container'
      condition: always()

- stage: deploy 
  displayName: Build Docker and Deploy
  jobs:
  - job: build_docker
    steps:
      - task: Docker@2
        displayName: Build and push an image to container registry
        inputs:
          command: buildAndPush
          repository: $(imageRepository)
          dockerfile: $(dockerfilePath)
          containerRegistry: $(dockerRegistryServiceConnection)
          tags: |
              $(tag)
